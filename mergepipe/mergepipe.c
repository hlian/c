#include <assert.h>
#include <limits.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

#include <sys/types.h>

void debug(int *array, int start, int end) {
    for (size_t i = start; i < end; i++) {
        printf("(%lu %d), ", i, array[i]);
    }
    printf("\n");
}

int mywrite(int fd, int data) {
    int ret = write(fd, &data, sizeof(int));
    return ret;
}

void merge(int leftpipe, int rightpipe, int dst) {
    int leftdone = -1;
    int rightdone = 0;
    int left = -1;
    int right = -1;
    int ret;

    ret = read(rightpipe, &right, sizeof(int));
    if (ret == 0) {
        rightdone = 1;
        goto L1;
    }

 L1:
    if (leftdone == -1) leftdone = 0;
    else mywrite(dst, left);

    ret = read(leftpipe, &left, sizeof(int));
    if (ret == 0) {
        leftdone = 1;
        if (!rightdone) goto L2;
        else return;
    }
    assert(ret > 0);
    if (left <= right || rightdone) goto L1; else goto L2;

 L2:
    mywrite(dst, right);
    ret = read(rightpipe, &right, sizeof(int));
    if (ret == 0) {
        rightdone = 1;
        if (!leftdone) goto L1;
        else return;
    }
    assert(ret > 0);
    if (right < left || leftdone) goto L2; else goto L1;
}

void mergepipe(int *src, size_t start, size_t end, int dst) {
    int len = end - start;
    if (len == 1) {
        mywrite(dst, src[start]);
        return;
    }

    int leftpipes[2];
    int rightpipes[2];
    if (pipe(leftpipes) == -1 || pipe(rightpipes) == -1) {
        perror("pipe");
        exit(EXIT_FAILURE);
    }

    pid_t forked = fork();
    if (forked == 1) {
        perror("fork");
        exit(EXIT_FAILURE);
    }

    int half = start + len / 2;
    if (forked == 0) {
        // The child process recurses.
        close(leftpipes[0]);
        close(rightpipes[0]);
        mergepipe(src, start, half, leftpipes[1]);
        mergepipe(src, half, end, rightpipes[1]);
        close(leftpipes[1]);
        close(rightpipes[1]);
        exit(EXIT_SUCCESS);
    }
    else {
        // The parent process aggregates.
        close(leftpipes[1]);
        close(rightpipes[1]);
        merge(leftpipes[0], rightpipes[0], dst);
        close(leftpipes[0]);
        close(rightpipes[0]);
    }
}

int main(void) {
    int test[] = {225, 176, 858, 549, 41, 836, 745, 109, 120, 883, 727, 369, 119, 72, 862, 984, 227, 163, 424, 166, 735, 501, 416, 299, 88, 472, 304, 18, 563, 66, 891, 488, 719, 928, 783, 121, 716, 249, 205, 672, 112, 75, 929, 424, 863, 835, 707, 26, 459, 181, 528, 962, 55, 161, 903, 57, 853, 695, 668, 846, 81, 216, 78, 919, 85, 25, 205, 35, 485, 818, 610, 598, 788, 838, 461, 373, 704, 620, 217, 812, 468, 39, 166, 206, 697, 433, 47, 96, 120, 921, 800, 170, 564, 604, 230, 312, 688, 913, 25, 382, 634, 336, 580, 489, 558, 336, 354, 442, 662, 36, 496, 921, 421, 793, 555, 221, 523, 594, 165, 171, 474, 693, 434, 891, 864, 238, 175, 306, 949, 888, 800, 561, 246, 423, 829, 527, 652, 80, 219, 105, 18, 991, 312, 902, 728, 857, 783, 111, 413, 460, 986, 22, 468, 557, 352, 296, 739, 919, 997, 15, 46, 972, 412, 61, 84, 126, 723, 252, 346, 992, 443, 659, 721, 387, 770, 726, 60, 17, 956, 415, 475, 91, 994, 630, 672, 678, 660, 408, 915, 166, 71, 88, 556, 932, 379, 516, 219, 996, 686, 526, 662, 555, 307, 69, 121, 812, 185, 50, 959, 321, 737, 748, 125, 261, 249, 290, 49, 80, 368, 988, 808, 312, 124, 509, 220, 126, 755, 527, 763, 669, 870, 579, 293, 136, 733, 551, 549, 221, 430, 617, 478, 197, 449, 611, 432, 27, 825, 302, 132, 197, 455, 940, 974, 580, 551, 38, 641, 1000, 87, 91, 278, 748, 130, 740, 551, 195, 406, 723, 476, 148, 8, 78, 785, 191, 666, 672, 303, 72, 322, 890, 394, 910, 561, 125, 994, 746, 491, 605, 822, 826, 124, 612, 80, 980, 627, 470, 476, 120, 783, 848, 236, 146, 299, 314, 324, 418, 513, 794, 108, 560, 392, 575, 715, 934, 598, 434, 717, 362, 382, 743, 502, 259, 436, 374, 340, 193, 378, 232, 289, 803, 322, 834, 700, 573, 283, 82, 658, 870, 206, 895, 227, 166, 937, 777, 489, 563, 238, 706, 368, 708, 449, 997, 32, 661, 174, 791, 622, 731, 819, 380, 335, 226, 327, 553, 910, 762, 365, 48, 175, 534, 32, 277, 143, 553, 212, 56, 905, 673, 358, 224, 382, 657, 626, 763, 721, 674, 59, 572, 386, 177, 495, 497, 941, 559, 64, 933, 17, 986, 543, 612, 595, 661, 436, 735, 958, 243, 201, 844, 762, 882, 158, 414, 834, 642, 965, 205, 760, 26, 428, 610, 997, 347, 985, 886, 603, 690, 361, 751, 92, 502, 519, 679, 233, 95, 987, 585, 35, 547, 405, 944, 423, 769, 425, 998, 41, 253, 103, 518, 555, 269, 925, 255, 570, 219, 90, 960, 243, 947, 1000, 367, 313, 114, 495, 143, 732, 347, 955, 328, 197, 300, 281, 530, 439, 395, 650, 874, 868, 677, 278, 3, 878, 158, 709, 313, 252, 102, 444, 935, 363, 477, 454, 677, 164, 483, 180, 258, 123, 11, 478, 725, 96, 609, 26, 59, 299, 707, 178, 803, 182, 247, 308, 909, 700, 380, 977, 992, 649, 378, 151, 255, 603, 586, 429, 843, 437, 93, 42, 519, 901, 151, 366, 105, 95, 265, 256, 671, 493, 781, 320, 799, 819, 537, 754, 879, 618, 3, 345, 581, 674, 774, 779, 715, 641, 903, 153, 70, 485, 904, 992, 400, 265, 487, 938, 340, 988, 464, 772, 294, 99, 970, 21, 174, 967, 432, 310, 520, 791, 249, 614, 826, 717, 851, 25, 428, 368, 828, 940, 29, 24, 861, 389, 388, 567, 576, 321, 148, 463, 571, 451, 710, 430, 848, 203, 231, 535, 390, 251, 235, 540, 959, 503, 791, 419, 965, 278, 267, 554, 538, 957, 920, 512, 770, 179, 285, 211, 742, 302, 152, 389, 694, 401, 549, 165, 749, 726, 294, 868, 716, 786, 311, 461, 13, 321, 813, 35, 294, 851, 209, 511, 222, 429, 137, 16, 889, 314, 735, 762, 76, 340, 621, 452, 617, 780, 727, 177, 720, 629, 397, 794, 640, 505, 532, 112, 535, 51, 312, 468, 938, 306, 416, 655, 251, 186, 67, 766, 636, 716, 548, 990, 838, 181, 379, 342, 754, 626, 326, 80, 556, 693, 880, 874, 344, 166, 213, 163, 554, 392, 629, 13, 37, 330, 492, 309, 828, 788, 582, 141, 56, 314, 607, 266, 32, 950, 745, 58, 514, 884, 128, 14, 900, 142, 174, 416, 443, 501, 332, 987, 707, 628, 741, 617, 84, 143, 278, 280, 273, 807, 608, 1, 774, 970, 136, 307, 281, 619, 203, 620, 708, 561, 362, 960, 646, 770, 224, 102, 999, 247, 339, 191, 359, 526, 438, 153, 279, 535, 109, 607, 22, 378, 779, 159, 633, 92, 8, 681, 715, 70, 761, 313, 128, 555, 313, 757, 266, 717, 383, 462, 304, 400, 685, 510, 169, 117, 778, 77, 770, 279, 488, 204, 205, 152, 639, 9, 799, 293, 570, 106, 817, 240, 355, 693, 86, 279, 27, 224, 160, 348, 713, 431, 974, 112, 801, 185, 566, 245, 820, 825, 78, 506, 395, 446, 163, 49, 362, 643, 536, 958, 802, 892, 848, 138, 86, 910, 420, 406, 614, 608, 516, 550, 15, 494, 256, 619, 858, 962, 650, 267, 382, 769, 557, 352, 103, 195, 785, 905, 916, 177, 17, 547, 328, 694, 728, 236, 68, 932, 971, 166, 404, 474, 886, 66, 119, 900, 392, 372, 360, 972, 283, 667, 477, 632, 877, 328, 89, 93, 656, 636, 306, 921, 164, 650, 787, 947, 607, 239, 139, 729, 997, 733, 668, 529, 87, 747, 858, 471, 211, 110, 261, 866, 942, 948, 370, 375, 461, 282, 970, 405, 779, 926, 506, 367, 923, 649, 662, 913, 957, 880, 612, 695, 54, 808, 349, 210, 703, 158, 835, 910, 578, 621, 506, 259, 241, 891, 586, 657, 833, 523, 6, 120, 440, 717, 737, 286, 83, 831, 507, 57, 23, 36, 693, 369, 506, 677, 348, 289, 254, 420, 118, 853, 748, 761, 942, 114, 655, 147, 287, 793, 623, 313, 567};
    int length = sizeof(test) / sizeof(int);

    int resultpipes[2];
    pipe(resultpipes);
    mergepipe(test, 0, length, resultpipes[1]);
    for (size_t i = 0; i < length; i++) {
        int tmp;
        read(resultpipes[0], &tmp, sizeof(int));
        printf("%d\n", tmp);
    }
    close(resultpipes[0]);
    close(resultpipes[1]);
    return 0;
}
